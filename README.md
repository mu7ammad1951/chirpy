# Chirpy

A simple social media application written in Go (Golang). Chirpy allows users to sign up, log in, create short messages ("chirps"), update their profiles, and more. It demonstrates basic usage of Go’s standard library, RESTful endpoints, JWT-based authentication, refresh token functionality, and Postgres data persistence via SQL migrations (managed by `sqlc` and goose migrations).

---

## Overview

**Chirpy** is designed to be a minimalist microblogging platform that demonstrates:
- Handling user registration and secure authentication (with hashed passwords).
- Managing JWT tokens and refresh tokens for session management.
- Enforcing short message (chirp) length constraints (up to 140 characters).
- Basic CRUD operations on a Postgres database, with SQL migrations and queries generated by [sqlc](https://github.com/kyleconroy/sqlc).
- **Example** integration with an external “Polka” API key system for user upgrade events.

---

## Features

- **User Authentication**:
  - **Sign-up** with email and password.
  - **Login** to receive both an access token (JWT) and a refresh token.
  - **Refresh** tokens to maintain long-lived sessions without storing secrets on the client.
- **Chirps**:
  - **Create** short messages (“chirps”) with minimal profanity filtering.
  - **Retrieve** chirps globally or by user, optionally sorted by creation date.
  - **Delete** chirps if you are the creator.
- **Administrative & Readiness**:
  - **Metrics** endpoint for tracking hits on the file server.
  - **Reset** endpoint (for dev environment) to clear user data.
  - **Readiness** endpoint (`/api/healthz`) to quickly check server status.

---

## Project Structure

A high-level overview of the most important files/folders:

```
.
├── assets/                   # Static assets (logo, etc.)
├── internal/
│   ├── auth/                 # Authentication logic (JWT, password hashing, refresh tokens, etc.)
│   └── database/             # SQL queries and models auto-generated by sqlc
├── sql/
│   ├── queries/              # Plain .sql files used by sqlc
│   └── schema/               # Database migration files
├── handler_*.go              # HTTP request handlers
├── chirp.go                  # Helper for "chirp" domain logic (validation, profanity filtering)
├── main.go                   # Application entry point & routing
├── gather_files.sh           # Script to gather all files into one text file
├── index.html                # Simple HTML welcome page
├── go.mod / go.sum           # Go modules and dependency tracking
└── README.md                 # You are reading this
```

**Key folders and files**:
- **`internal/auth`**: 
  - `authentication.go` & `authentication_test.go`: handles Bearer tokens, password hashing, test coverage.
  - `jwt_auth.go`: generates and validates JWTs.
  - `refresh_token.go`: helper for creating secure refresh tokens.
  - `polka_api.go`: example of retrieving an API key from request headers.
- **`internal/database`**: 
  - `.sql.go` files: auto-generated from `.sql` queries in `sql/queries`.
  - `models.go`: auto-generated SQL models.
  - `db.go`: sets up a `Queries` struct for interacting with the DB.
- **`sql/queries/*.sql`**: custom SQL queries used in your app (for chirps, users, refresh tokens).
- **`sql/schema/*.sql`**: migration files for initial schema and subsequent schema changes.

---

## Installation

1. **Clone the repository**:

   ```bash
   git clone https://github.com/your-username/chirpy-boot.git
   cd chirpy-boot
   ```

2. **Install dependencies**:

   ```bash
   go mod download
   ```

3. **(Optional) Install sqlc** (if you want to re-generate database code):
   
   ```bash
   go install github.com/kyleconroy/sqlc/cmd/sqlc@latest
   ```
   
   - Then run `sqlc generate` to re-generate `.sql.go` files from `sql/queries` if needed.

---

## Environment Variables

Your application relies on a few environment variables (loaded automatically by [`github.com/joho/godotenv`](https://github.com/joho/godotenv)):

- **`DB_URL`**: A Postgres connection string, for example `postgres://user:password@hostname:5432/dbname?sslmode=disable`.
- **`PLATFORM`**: I used `"dev"` to guard certain dev-only endpoints (like `/admin/reset`).
- **`SECRET_STRING`**: A secret key used to sign JWT tokens. **Must** be kept secure.
- **`POLKA_KEY`**: An API key used for Polka webhooks to upgrade a user. (Hypothetical payment gateway)

You can place these in a `.env` file at the root of your project so that `godotenv` can load them automatically:

```
DB_URL=postgres://localhost:5432/chirpy?sslmode=disable
PLATFORM=dev
SECRET_STRING=your_secret_here
POLKA_KEY=some_api_key
```

---

## Database

### 1. Migrations

The project uses Goose migrations (`001_users.sql`, `002_chirps.sql`, etc.) in the `sql/schema/` directory. Each file has an **Up** and **Down** section, which create or drop tables.

To run migrations, you should:
- Ensure you have Goose installed.
- Run the command:
  
  ```bash
  goose postgres "$DB_URL" up
  ```

### 2. Queries

SQL queries for CRUD operations on `users`, `chirps`, and `refresh_tokens` are in `sql/queries/`. The [sqlc](https://github.com/kyleconroy/sqlc) tool compiles these queries into Go methods in the `internal/database` package.

---

## Running the Server

```bash
go run .
```
**OR**
```base
go build -o chirpy 
./chirpy 
```

By default, the server listens on `:8080`. If everything is correctly set up, you should see a log message:

```
Serving files from . on port: 8080
```

Then, open a web browser to `http://localhost:8080/app/index.html` (or just `http://localhost:8080/app/`) to see the default file server.

---

## API Endpoints

### Health & Admin
| Method | Endpoint         | Description                                              |
|--------|------------------|----------------------------------------------------------|
| **GET**    | `/api/healthz`     | Readiness check (always returns `200 OK`)              |
| **GET**    | `/admin/metrics`   | Displays file server metrics (no auth required)         |
| **POST**   | `/admin/reset`     | Resets the users table (only works if `PLATFORM=dev`)   |

### Authentication & Users
| Method | Endpoint          | Description                                             |
|--------|-------------------|---------------------------------------------------------|
| **POST**   | `/api/users`       | Create a new user (sign up)                           |
| **POST**   | `/api/login`       | Log in, returning an access & refresh token           |
| **POST**   | `/api/refresh`     | Exchange a refresh token for a new JWT                |
| **POST**   | `/api/revoke`      | Revoke a refresh token                                |
| **PUT**    | `/api/users`       | Update the user’s email/password (requires JWT)       |

### Chirps
| Method   | Endpoint               | Description                                                                 |
|----------|------------------------|-----------------------------------------------------------------------------|
| **POST**   | `/api/chirps`          | Create a chirp (requires JWT)                                              |
| **GET**    | `/api/chirps`          | List chirps, supports `?author_id=...` and `?sort=[asc/desc]`                |
| **GET**    | `/api/chirps/{chirpID}` | Get a single chirp by ID                                                   |
| **DELETE** | `/api/chirps/{chirpID}` | Delete your own chirp (requires JWT)                                       |

### Webhooks
| Method | Endpoint              | Description                                      |
|--------|-----------------------|--------------------------------------------------|
| **POST**   | `/api/polka/webhooks` | Webhook endpoint that upgrades a user via "Polka" API key |

### Example Usage

1. **Sign Up**:
   ```shell
   curl -X POST -H "Content-Type: application/json" \
        -d '{"email":"test@example.com","password":"Secret123"}' \
        http://localhost:8080/api/users
   ```

2. **Login**:
   ```shell
   curl -X POST -H "Content-Type: application/json" \
        -d '{"email":"test@example.com","password":"Secret123"}' \
        http://localhost:8080/api/login
   ```
   Returns:
   ```json
   {
     "id":"<uuid>",
     "created_at":"2025-02-17T12:34:56Z",
     "updated_at":"2025-02-17T12:34:56Z",
     "email":"test@example.com",
     "is_chirpy_red":false,
     "token":"<JWT>",
     "refresh_token":"<RefreshTokenString>"
   }
   ```

3. **Create Chirp** (JWT required):
   ```shell
   curl -X POST -H "Content-Type: application/json" \
        -H "Authorization: Bearer <JWT>" \
        -d '{"body":"Hello Chirpy!"}' \
        http://localhost:8080/api/chirps
   ```

4. **List Chirps**:
   ```shell
   curl http://localhost:8080/api/chirps
   ```


---


## Contributing

1. **Fork** the repository.
2. **Create** a new feature branch.
3. **Commit** your changes.
4. **Push** to your branch.
5. **Open** a Pull Request.

I welcome all suggestions and improvements—feel free to submit an issue or PR!

---

**Thank you for checking out Chirpy!**  
If you have any questions, please open an issue or reach out. Enjoy!